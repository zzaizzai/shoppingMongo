<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">

    <link rel="stylesheet" href="/public/main.css">

    <title>Hello, world!</title>
  </head>
  <body>

    

    <%- include('navbar.html') %>
  
    <div class="container p-4 detail">

        <div class="row">
          <div class="col-3">
            <ul class="list-group chat-list">
                <% for (let i = 0; i< data.length; i++){ %>
              <li class="list-group-item" data-id="<%= data[i]._id %>">
                <h6><%= data[i].title %></h6>
                <h6 class="text-small"><%= data[i].member[0] %></h6>
              </li>
              <%  } %>
             </ul>
           </div>
      
           <div class="col-9 p-0">
             <div class="chat-room">
                <ul class="list-group chat-content">
                  <li><span class="chat-box">채팅방1 내용</span></li>
                  <li><span class="chat-box">채팅방1 내용</span></li>
                  <li><span class="chat-box mine">채팅방1 내용</span></li>
                </ul>
              <div class="input-group">
                <input class="form-control" id="chat-input">
                <button class="btn btn-secondary" id="send">send</button>
              </div>
            </div>
          </div>
        </div>
      
      </div>


      <script>

          var currentChatRoom;
          var eventSource;

          $('.list-group-item').click(function(){
              currentChatRoom = this.dataset.id;
              $('.chat-content').html('');

              if (eventSource != undefined) {
                  eventSource.close()
              }

            eventSource = new EventSource('/message/' + currentChatRoom )
            eventSource.addEventListener('test', function(e){
                console.log(JSON.parse(e.data));
                var msData = JSON.parse(e.data);
                msData.forEach(function(i){
                    $('.chat-content').append('<li><span class="chat-box">' + i.content + '</span></li>')
                    
                });
            })
          })

          $('#send').click(function(){
              var messageData ={
                  parent : currentChatRoom,
                  content :$('#chat-input').val(),
              }
              $.post('/message', messageData).then(()=>{
                  console.log('send done')
              })
          })
 


      </script>


  </body>
</html>